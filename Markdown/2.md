---

# 图书借阅系统开发实训 - 第二天

**实训主题**：管理员图书管理功能
**技术栈**：Spring Boot 3.5.9 + MyBatis-Plus 3.5.7 + MariaDB + HTML/Axios
**认证方式**：原生拦截器 + Hutool JWT

---

## 📌 今日目标

完成管理员端图书管理：登录后查看图书列表，新增/编辑/删除图书，并能查看某本书的借阅记录。

**前置准备**（沿用第一天成果）：
- MariaDB 中已有 `library_db` 并插入基础图书/用户数据。
- 后端能正常启动（`mvn spring-boot:run`），前端静态站点可访问。
- localStorage 已存储登录后下发的 `library_token`，可用于接口调用。

---

## ✅ 今日验收标准

- [x] **后端接口可用**：获取图书列表、新增、编辑、删除、查看借阅记录接口均可正常调用
- [x] **管理员登录后展示列表**：`admin` 登录跳转后，能在 `/pages/admin/books.html` 看到图书列表数据
- [x] **图书增删改生效**：新增/编辑/删除后刷新列表数据，数据库同步更新
- [x] **借阅记录可查看**：点击某本书的记录入口，可跳转到 `book_record.html` 并加载该书借阅记录
- [x] **无跨域/权限报错**：控制台无红色错误，Network 中接口返回正常
- [x] **数据一致性校验**：删除图书前若存在未归还记录，需给出提示并阻止删除（可选但推荐）

---

## 第一步：后端图书管理 API（预计用时：60 分钟）

1. **获取图书列表**
   - 控制器：实现 `/api/books` GET
   - 逻辑：查询全部图书，返回列表
   - 建议：支持简单查询/分页（MyBatis-Plus `Page`）以便后续扩展

2. **新增图书**
   - 控制器：`/api/books` POST
   - 逻辑：校验必填字段（书名、库存），插入记录
   - 库存字段：total_quantity，available_quantity，borrowed_quantity 初始为 0 或按需求设置

3. **编辑图书**
   - 控制器：`/api/books/{id}` PUT
   - 逻辑：根据 ID 更新图书信息
   - 注意：保持 available_quantity 不为负数；如 total_quantity 变小，需校验已借数量

4. **删除图书**
   - 控制器：`/api/books/{id}` DELETE
   - 逻辑：根据 ID 删除图书
   - 建议：若该书存在未归还记录则拒绝删除，返回友好提示

5. **按图书 ID 查询借阅记录**
   - 控制器：`/api/books/{id}/records` GET
   - 逻辑：联查 `borrow_record` 与 `user`/`book`，返回该书的借阅/归还记录
   - 输出字段：借阅人、状态（BORROWED/RETURNED）、借出时间、归还时间

6. **当前管理员信息接口（可选）**
   - 控制器：`/api/me` GET
   - 逻辑：解析 Token，返回用户名/角色，便于前端展示

> 开发提示：
> - Mapper 继承 `BaseMapper`，复杂查询可用 `LambdaQueryWrapper`。
> - 开发顺序：先实体与 Mapper → Controller → 局部自测（Postman/curl）。
> - MariaDB 连接字符串已在 `application.yml` 配置，确保服务运行 (`systemctl status mariadb.service`)。

---

## 第二步：前端管理员页面（预计用时：60 分钟）

1. **页面框架**
   - 文件：`/pages/admin/books.html`
   - 引入顺序：Axios CDN → `config.js` → `utils/*.js` → `api/*.js` → `modules/*.js`

2. **API 封装**
   - `js/api/book.js`（如需新增）：封装列表、新增、编辑、删除、记录查询接口

3. **业务脚本**
   - `js/modules/admin-books.js`（命名按习惯）：
     - 页面加载时获取并渲染图书列表
     - 新增/编辑表单提交后刷新列表
     - 删除按钮确认后调用删除接口
     - “查看借阅记录”按钮跳转到 `pages/admin/book_record.html?id=<bookId>`
     - 可选：提供简单搜索/过滤（按书名关键字）

4. **UI 交互**
   - 使用 SweetAlert2 处理确认/提示
   - 使用 NProgress 展示请求进度
   - 操作成功后重载数据，失败弹出错误信息

---

## 第三步：借阅记录页面（预计用时：40 分钟）

1. **页面文件**：`/pages/admin/book_record.html`
2. **逻辑**：
   - 从 URL 读取 `bookId`
   - 调用 `/api/books/{id}/records` 获取记录
   - 渲染借阅人、借出时间、归还时间、状态
3. **体验**：
   - 无数据时显示友好占位
   - 返回按钮跳回图书列表
   - 若查询失败，提示“请确认已登录并服务器可用”，并展示重试按钮

---

## ✅ 第二天验收检查清单

- [x] 后端图书接口（列表/增/改/删/记录）全部返回成功
- [x] 管理员登录后能看到图书列表数据
- [x] 新增/编辑/删除操作后列表实时更新且落库
- [x] 借阅记录页能按图书 ID 加载记录
- [x] 浏览器 Console/Network 无红色报错
- [x]（可选）删除被占用图书时有友好提示，且操作被阻止
- [x]（可选）列表支持简单搜索/分页

---

## 🐛 常见问题排查

- **列表为空**：检查数据库是否有图书，接口是否指向正确的 baseURL
- **操作无效**：确认请求方法与路径匹配（POST/PUT/DELETE），以及后端是否开启拦截器放行登录接口
- **跨域/权限错误**：检查 Token 是否随请求发送，`WebConfig` 跨域配置是否包含前端端口
- **借阅记录不显示**：确认 URL 携带了 `bookId`，并核对后端查询是否使用正确的参数
- **删除报错**：若存在未归还记录，应提示不可删除；如无提示，检查后端校验逻辑
- **MariaDB 连接异常**：核对 `application.yml` 的 url/用户名/密码，确认数据库已启动

---

## 今日知识点提示

- **MyBatis-Plus CRUD**：`BaseMapper` 直接提供增删改查，复杂查询用 `LambdaQueryWrapper`
- **数据一致性**：删除图书前可校验是否存在未归还记录
- **前端分层**：配置层→工具层→API 层→业务层→页面层，修改定位更清晰
- **接口幂等性**：重复提交新增/编辑时可通过前端按钮禁用和后端参数校验避免重复写入
