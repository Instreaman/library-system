---

# 图书借阅系统开发实训 - 第三天

**实训主题**：普通用户借阅与归还功能
**技术栈**：Spring Boot 3.5.9 + MyBatis-Plus 3.5.7 + MariaDB + HTML/Axios
**认证方式**：原生拦截器 + Hutool JWT

---

## 📌 今日目标

完成普通用户端：查看已借图书、归还图书、进入借书页并借阅可用图书，保证库存与记录同步更新。

**前置准备**：
- 第二天的图书管理接口已可用，数据库中存在可借图书。
- 用户 `user1` / `user123` 可正常登录并拿到 Token。
- 后端和前端服务已启动，Network 中请求指向正确的后端 baseURL。

---

## 🕵️ 仓库现状速览（基于当前代码）

- 后端：已提供 `/api/login`、`/api/me`、`/api/books` CRUD，尚无借阅相关 Controller/Service。
- 拦截器：`LoginInterceptor` 已把 `userId` / `username` / `role` 写入 request attribute，可直接做用户隔离。
- 数据库：`borrow_record` 含 `borrow_date` / `return_date` / `due_date` / `status`（默认 BORROWED），外键约束开启。
- 前端：登录页 + 管理端已接 Book API，`/pages/user/books.html` 仍是占位；`js/api` 没有借阅接口，`js/modules` 缺少用户侧脚本和借书页。

---

## ✅ 今日验收标准

- [ ] **用户登录后信息展示**：`user1` 登录跳转 `/pages/user/books.html`，能看到自己的昵称/用户名
- [ ] **已借列表可见**：页面展示当前用户已借图书及状态
- [ ] **归还成功**：点击归还后，记录状态更新为 RETURNED，图书可用数量增加
- [ ] **可借列表加载**：`borrow_book.html` 能列出可借图书（可用库存 > 0）
- [ ] **借书成功**：点击借书后创建借阅记录、减少可用数量，返回成功提示
- [ ] **无错误日志**：浏览器 Console/Network 无红色报错，接口返回正常
- [ ] **越权防护**：接口按 Token 解析的用户 ID 过滤数据，无法查看他人记录

---

## 第一步：后端用户端 API（预计用时：60 分钟）

1. **获取当前用户已借图书**
   - 控制器：`/api/user/borrowed` GET
   - 逻辑：按 Token 解析的用户 ID 查询 borrow_record，附带图书信息
   - 输出字段：书名、借出时间、状态、recordId，方便前端归还操作

2. **归还图书**
   - 控制器：`/api/user/return/{recordId}` POST/PUT（任选其一保持一致）
   - 逻辑：更新借阅记录状态为 RETURNED，记录归还时间，图书可用数量 +1、已借数量 -1
   - 幂等校验：若状态已是 RETURNED，直接返回成功提示，避免重复扣减/增减库存

3. **获取可借图书列表**
   - 控制器：`/api/user/available-books` GET
   - 逻辑：筛选可用数量 > 0 的图书并返回
   - 可选：支持关键字搜索，减轻前端筛选压力

4. **借书**
   - 控制器：`/api/user/borrow/{bookId}` POST
   - 逻辑：创建借阅记录（BORROWED 状态，写入借出时间、bookId、userId），图书可用数量 -1、已借数量 +1
   - 业务校验：
     - 可用数量需大于 0
     - 同一用户是否允许借多本同名书（按需求决定），必要时做限制

5. **当前用户信息接口**
   - 控制器：`/api/me` GET（如第二天已实现可复用）
   - 逻辑：返回用户名/角色给前端展示

> 仓库落地指引：
> - 新建 `service/BorrowService`（`@Transactional`）：`borrow(Long bookId, Long userId)` 与 `returnBook(Long recordId, Long userId)` 内部完成库存校验、记录写入/更新。使用 `BookMapper` + `BorrowRecordMapper`，在借书时校验 `availableQuantity > 0`，归还时校验记录归属和状态，幂等直接 return success。
> - 新建 `controller/BorrowController`（建议前缀 `/api/user`）：`GET /borrowed`、`GET /available-books`、`POST /borrow/{bookId}`、`POST /return/{recordId}`，从 `request.getAttribute("userId")` 拿当前用户，统一返回 `Result`。
> - 可借列表：`LambdaQueryWrapper<Book>().gt(Book::getAvailableQuantity, 0)`，可选 `like` 书名/作者。
> - 幂等与越权：归还时校验 `status` 已是 RETURNED 则直接 success，借还操作均校验 `record.userId == currentUserId`。
> - 日志：调试阶段打开 MyBatis-Plus SQL，方便核对库存和记录同步。

---

## 第二步：用户主页（预计用时：50 分钟）

1. **页面文件**：`/pages/user/books.html`
2. **引入顺序**：Axios CDN → `config.js` → `utils/*.js` → `api/*.js` → `modules/*.js`
3. **业务脚本**（当前仓库缺失，需要新增 `js/api/borrow.js` + `js/modules/user-books.js`）：
   - 加载用户信息并显示
   - 调用 `/api/user/borrowed` 渲染已借列表（书名、借出时间、状态）
   - 每条记录提供“归还”按钮：调用归还接口，成功后刷新列表
   - “借新书”按钮跳转到 `pages/user/borrow_book.html`
   - 可选：在列表中直接展示归还状态标签与借出时长（前端计算）

4. **反馈与加载**：
   - NProgress 展示请求进度，SweetAlert2 弹窗提示成功/失败
   - 无数据时展示空状态提示
   - 归还按钮在请求期间禁用，防止重复提交

---

## 第三步：借书页面（预计用时：40 分钟）

1. **页面文件**：`/pages/user/borrow_book.html`（当前不存在，需新增）
2. **业务脚本**（新增 `js/modules/user-borrow.js`，复用 `js/api/borrow.js`）：
   - 页面加载时调用 `/api/user/available-books` 获取列表
   - 展示书名/作者/库存，可用数量
   - 每本书提供“借出”按钮：调用 `/api/user/borrow/{bookId}`，成功后更新列表（或跳回上一页）
   - 可选：展示剩余可借数量并在 0 时禁用按钮

3. **体验优化**：
   - 禁用按钮或提示可用库存为 0 的情况
   - 操作成功后短暂提示，再刷新数据
   - 借书成功后可选择停留刷新列表或返回上一页，给出两种按钮

---

## 联调小抄

1. 登录 `user1/user123` 获取 Token（浏览器存储在 `library_token`）。
2. Postman 验证：按顺序调用 `GET /api/user/available-books` → `POST /api/user/borrow/{id}` → `GET /api/user/borrowed` → `POST /api/user/return/{recordId}`，核对数据库库存/记录同步。
3. 前端自测：在用户页借还后刷新列表，观察 NProgress/SweetAlert2、Console/Network 无红色报错。

---

## ✅ 第三天验收检查清单

- [ ] `user1` 登录后能在 `/pages/user/books.html` 看到自己的已借列表
- [ ] 点击归还后记录状态更新，库存同步变更
- [ ] `borrow_book.html` 能列出可借书籍并成功借出
- [ ] 借还操作后页面数据刷新且数据库一致
- [ ] Console/Network 无红色报错，接口响应符合预期
- [ ] 借书/还书接口具备幂等与库存校验，防止重复操作

---

## 🐛 常见问题排查

- **归还无效**：确认接口方法与路径一致，记录状态更新及库存同步是否在同一事务
- **可借列表为空**：检查数据库可用数量是否大于 0，或接口是否过滤过严
- **借书失败**：确认 Token 解析的用户 ID 正常写入记录，库存扣减逻辑是否正确
- **跨页跳转异常**：检查链接路径是否正确、是否携带必要参数，前端路由是否指向静态文件
- **重复归还/借书**：前端按钮需禁用，后端做状态校验；日志观察是否出现重复更新
- **时区导致时间异常**：核对 `application.yml` 的 time-zone 设置与数据库时区一致

---

## 今日知识点提示

- **库存与记录同步**：借书/还书需同时更新 `book` 库存与 `borrow_record` 状态，避免脏数据
- **幂等性**：避免重复归还或重复借阅同一本书的同一记录，可在接口侧做状态校验
- **用户隔离**：查询借阅记录必须按当前用户过滤，防止越权
- **前端分层**：继续保持配置→工具→API→业务→页面的拆分，便于迭代
- **事务与锁**：关键更新放事务内，必要时对库存更新使用行级锁，避免并发下的负库存
