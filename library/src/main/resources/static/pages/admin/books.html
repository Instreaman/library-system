<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图书管理 - 管理员</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- RemixIcon -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <!-- NProgress -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.css">
    <script src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- AutoAnimate -->
    <script src="https://cdn.jsdelivr.net/npm/@formkit/auto-animate@1.0.0-beta.3/dist/auto-animate.min.js"></script>
    <!-- Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.2/dist/axios.min.js"></script>
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>

    <!-- 配置与业务脚本 -->
    <script src="../../js/config.js"></script>
    <script src="../../js/utils/storage.js"></script>
    <script src="../../js/utils/http.js"></script>
    <script src="../../js/api/auth.js"></script>
    <script src="../../js/api/book.js"></script>
    <script src="../../js/modules/admin-books.js"></script>

    <style>
        [x-cloak] { display: none !important; }
        #nprogress .bar { background: #ef4444 !important; }
    </style>
</head>
<body class="bg-gray-50" x-data="adminBooksModule()" x-init="init()" x-cloak>
    <div class="min-h-screen">
        <!-- 顶部导航 -->
        <header class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <span class="p-2 bg-black text-white rounded-lg"><i class="ri-book-2-line text-xl"></i></span>
                    <div>
                        <h1 class="text-xl font-semibold text-gray-900">图书管理</h1>
                        <p class="text-sm text-gray-500">管理员控制台</p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <span class="text-sm text-gray-600 hidden sm:inline">欢迎，<span x-text="StorageUtil.getUsername() || '管理员'"></span></span>
                    <button @click="logout" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg border border-gray-200 transition">
                        <i class="ri-logout-box-r-line mr-2"></i>退出
                    </button>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 space-y-6">
            <!-- 操作栏 -->
            <div class="bg-white shadow rounded-xl p-4 sm:p-6">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-3 sm:space-y-0">
                    <div class="flex items-center space-x-3">
                        <div class="relative w-full sm:w-64">
                            <i class="ri-search-line absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            <input type="text" placeholder="搜索书名、作者、出版社" x-model="keyword" class="w-full pl-10 pr-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900">
                        </div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <button @click="openCreate" class="inline-flex items-center px-4 py-2 bg-black text-white text-sm font-medium rounded-lg hover:bg-gray-800 transition">
                            <i class="ri-add-line mr-2"></i>新增图书
                        </button>
                    </div>
                </div>
            </div>

            <!-- 列表 -->
            <div class="bg-white shadow rounded-xl overflow-hidden">
                <div class="overflow-x-auto" x-init="$nextTick(() => window.autoAnimate && window.autoAnimate($refs.bookTable))">
                    <table class="min-w-full divide-y divide-gray-200" x-ref="bookTable">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">书名</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">作者</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">出版社</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ISBN</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">库存</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">可借</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">已借出</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-if="loading">
                                <tr>
                                    <td colspan="8" class="px-4 py-6 text-center text-gray-500">加载中...</td>
                                </tr>
                            </template>
                            <template x-if="!loading && filteredBooks().length === 0">
                                <tr>
                                    <td colspan="8" class="px-4 py-6 text-center text-gray-500">暂无数据</td>
                                </tr>
                            </template>
                            <template x-for="book in filteredBooks()" :key="book.id">
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-3">
                                        <div class="text-sm font-medium text-gray-900" x-text="book.title"></div>
                                        <div class="text-xs text-gray-500" x-text="book.id"></div>
                                    </td>
                                    <td class="px-4 py-3 text-sm text-gray-700" x-text="book.author || '-'"> </td>
                                    <td class="px-4 py-3 text-sm text-gray-700" x-text="book.publisher || '-'"> </td>
                                    <td class="px-4 py-3 text-sm text-gray-700" x-text="book.isbn || '-'"> </td>
                                    <td class="px-4 py-3 text-center text-sm text-gray-900" x-text="book.totalQuantity ?? 0"></td>
                                    <td class="px-4 py-3 text-center text-sm text-emerald-600 font-semibold" x-text="book.availableQuantity ?? 0"></td>
                                    <td class="px-4 py-3 text-center text-sm text-amber-600 font-semibold" x-text="borrowedQuantity(book)"></td>
                                    <td class="px-4 py-3 text-center text-sm">
                                        <div class="flex items-center justify-center space-x-2">
                                            <button @click="goRecords(book)" class="px-2 py-1 text-xs bg-blue-50 text-blue-700 rounded hover:bg-blue-100 transition">记录</button>
                                            <button @click="openEdit(book)" class="px-2 py-1 text-xs bg-gray-900 text-white rounded hover:bg-gray-800 transition">编辑</button>
                                            <button @click="confirmDelete(book)" class="px-2 py-1 text-xs bg-red-50 text-red-600 rounded hover:bg-red-100 transition">删除</button>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- 弹窗 -->
    <div x-show="modalOpen" class="fixed inset-0 z-40 flex items-center justify-center bg-black/30" x-transition>
        <div class="bg-white rounded-xl shadow-xl w-full max-w-lg p-6 relative">
            <button @click="modalOpen=false" class="absolute right-4 top-4 text-gray-400 hover:text-gray-600">
                <i class="ri-close-line text-xl"></i>
            </button>
            <h3 class="text-lg font-semibold mb-4" x-text="form.id ? '编辑图书' : '新增图书'"></h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">书名 *</label>
                    <input type="text" x-model="form.title" class="w-full rounded-lg border border-gray-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-gray-900">
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">作者</label>
                        <input type="text" x-model="form.author" class="w-full rounded-lg border border-gray-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-gray-900">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">出版社</label>
                        <input type="text" x-model="form.publisher" class="w-full rounded-lg border border-gray-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-gray-900">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ISBN *</label>
                    <input type="text" x-model="form.isbn" class="w-full rounded-lg border border-gray-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-gray-900">
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">总库存 *</label>
                        <input type="number" min="0" x-model.number="form.totalQuantity" class="w-full rounded-lg border border-gray-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-gray-900">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">可借数量</label>
                        <input type="number" min="0" x-model.number="form.availableQuantity" placeholder="留空则自动计算" class="w-full rounded-lg border border-gray-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-gray-900">
                    </div>
                </div>
                <div class="flex justify-end space-x-3 pt-2">
                    <button @click="modalOpen=false" class="px-4 py-2 text-sm rounded-lg border border-gray-200 text-gray-700 hover:bg-gray-50">取消</button>
                    <button @click="submitForm" class="px-4 py-2 text-sm rounded-lg bg-black text-white hover:bg-gray-800">保存</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
